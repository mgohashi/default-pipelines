pipeline {
  parameters {
    string(name: 'NAMESPACE_DEV', description: 'Informe o nome do Namespace de DEV?')
    string(name: 'NAMESPACE_HML', description: 'Informe o nome do Namespace de HML?')
    string(name: 'NAMESPACE_PRD', description: 'Informe o nome do Namespace de PRD?')
    string(name: 'APP_NAME', description: 'What is the Application name?')
    string(name: 'GIT_URL', description: 'What is the Git repository?')
    string(name: 'BRANCH', description: 'What is the Branch?')
    //string(name: 'SECRET', description: 'What is the Secret name?')
    //string(name: 'CONFIGMAP', description: 'What is the ConfigMap name?')
  }

  environment {
    PRODUCT_OWNERS_GROUP = 'P_IJK_APROVADOR_PRODUCAO'
    APPROVERS_GROUP = 'P_IJK_LIBERACAO_PRODUCAO'
    DEPLOYERS_GROUP = 'P_IJK_OPERADOR_PRODUCAO'

    //PRODUCT_OWNERS_GROUP = 'gestores'
    //APPROVERS_GROUP = 'aprovadores'
    //DEPLOYERS_GROUP = 'deployers'    
  }

  agent any

  stages {
    stage('Checkout') {
      steps {
        script {
          echo "Checkout source code from ${GIT_URL}..."
          git url: "${GIT_URL}", branch: "${BRANCH}"
        }
      }
    }
    stage('Configurar Pipeline') {
      steps {
        script {
          def branch = params.BRANCH

          if (branch == 'master') {
            echo 'Env = Production'
            env.REQUIRES_BUILD = 'N'
            env.REQUIRES_DEPLOYMENT = 'Y'
            env.REQUIRES_APPROVAL = 'Y'
            env.REQUIRES_PROMOTION = 'N'
            env.REQUIRES_DIRECT_PROMOTION = 'N'
            env.VERSION = 'MASTER'
          } else if (branch.matches('^release/.+$')) {
            echo 'Env = Release'
            env.REQUIRES_BUILD = 'Y'
            env.REQUIRES_DEPLOYMENT = 'Y'
            env.REQUIRES_APPROVAL = 'N'
            env.REQUIRES_PROMOTION = 'Y'
            env.REQUIRES_DIRECT_PROMOTION = 'N'
            env.VERSION = branch.replaceAll('^release/', '')
          } else if (branch.matches('^hotfix/.+$')) {
            echo 'Env = Hotfix'
            env.REQUIRES_BUILD = 'Y'
            env.REQUIRES_DEPLOYMENT = 'Y'
            env.REQUIRES_APPROVAL = 'Y'
            env.REQUIRES_PROMOTION = 'Y'
            env.REQUIRES_DIRECT_PROMOTION = 'Y'
            env.VERSION = branch.replaceAll('^hotfix/', '')
          } else if (branch == 'develop') {
            echo 'Env = Develop'
            env.REQUIRES_BUILD = 'Y'
            env.REQUIRES_DEPLOYMENT = 'Y'
            env.REQUIRES_APPROVAL = 'N'
            env.REQUIRES_PROMOTION = 'N'
            env.REQUIRES_DIRECT_PROMOTION = 'N'
            env.VERSION = 'DEVELOP'
          } else {
            echo 'Env = None'
            env.REQUIRES_BUILD = 'N'
            env.REQUIRES_DEPLOYMENT = 'N'
            env.REQUIRES_APPROVAL = 'N'
            env.REQUIRES_PROMOTION = 'N'
            env.REQUIRES_DIRECT_PROMOTION = 'N'
            env.VERSION = 'NONE'
          }

          sh 'printenv'
        }
      }
    }
    stage('Build') {
      when {
        environment name: 'REQUIRES_BUILD', value: 'Y'
      }
      steps {
        script {
          echo "Application build..."
        }
      }
    }
    stage('Unit Tests') {
      when {
        environment name: 'REQUIRES_BUILD', value: 'Y'
      }
      steps {
        script {
          echo "Running unit tests..."
        }
      }
    }
    stage('Static Analysis') {
      when {
        environment name: 'REQUIRES_BUILD', value: 'Y'
      }
      steps {
        script {
          echo "Running analysis..."
        }
      }
    }
    stage('Export Nexus') {
      when {
        environment name: 'REQUIRES_BUILD', value: 'Y'
      }
      steps {
        script {
          echo "Exporting to nexus..."
        }
      }
    }
    stage('Build Image') {
      when {
        allOf {
          environment name: 'REQUIRES_BUILD', value: 'Y'
          environment name: 'REQUIRES_DEPLOYMENT', value: 'Y'
        }
      }
      steps {
        script {
          echo "Building image..."
        }
      }//steps
    }//stage
    stage('Aprovar') {
      agent none
      when {
        allOf { 
          environment name: 'REQUIRES_DEPLOYMENT', value: 'Y'
          environment name: 'REQUIRES_APPROVAL', value: 'Y'
          environment name: 'REQUIRES_DIRECT_PROMOTION', value: 'N'
        }
      }
      steps {
        script {
          def branch = params.BRANCH
          def groupToApprove = env.PRODUCT_OWNERS_GROUP

          if (branch == 'master') {
              groupToApprove = env.DEPLOYERS_GROUP
          }

          input(
              message: "Você gostaria de aprovar o deployment da aplicação ${params.APP_NAME} - VERSAO: ${VERSION} - BUILD: ${BUILD_NUMBER}?",
              ok: "Sim, gostaria.",
              submitter: groupToApprove,
              submitterParameter: "USERNAME"
          )
        }
      }//steps
    }//stage
    stage('Deploy') {
      when {
        environment name: 'REQUIRES_DEPLOYMENT', value: 'Y'
        environment name: 'REQUIRES_DIRECT_PROMOTION', value: 'N'
      }
      steps {
        script {
          echo "Executing deployment..."
        }
      }//steps
    }//stage
    stage('Promover') {
      agent none
      when {
        allOf {
          environment name: 'REQUIRES_DEPLOYMENT', value: 'Y'
          environment name: 'REQUIRES_PROMOTION', value: 'Y'
        }
      }
      steps {
        script {
          input(
              message: "Você gostaria de liberar a promoção da aplicação ${APP_NAME} - VERSAO: ${VERSION} - BUILD: ${BUILD_NUMBER}?",
              ok: "Sim, gostaria.",
              submitter: env.APPROVERS_GROUP,
              submitterParameter: "USERNAME"
          )
        }
      }//steps
    }//stage
    stage('Promoting Image') {
      when {
        environment name: 'REQUIRES_DEPLOYMENT', value: 'Y'
        environment name: 'REQUIRES_PROMOTION', value: 'Y'
      }
      steps {
        script {
          echo "Promoting image..."
        }
      }//steps
    }//stage
    stage('Finalizando') {
      steps {
        script {
          echo "Finalizing..."
        }
      }
    }
  }//stages
}//pipeline
def requiresDeployment = true
def requiresApproval = true
def requiresPromotion = true
def requiresDirectPromotion = true
def approved = false
def promote = false

pipeline {
  parameters {
    string(name: 'NAMESPACE', description: 'What is the project name?')
    string(name: 'APP_NAME', description: 'What is the application name?')
    string(name: 'GIT_URL', description: 'What is the Git repository?')
  }
  agent any
  stages {
    stage('Checkout') {
      steps {
        script {
          echo "Checkout source code from ${GIT_URL}..."
        }
      }
    }
    stage('Configurar Build') {
      steps {
        script {
          echo "NAMESPACE=${NAMESPACE}"
          echo "APP_NAME=${APP_NAME}"
        }
      }
    }
    stage('Build') {
      steps {
        script {
          echo "Application build..."
        }
      }
    }
    stage('Unit Tests') {
      steps {
        script {
          echo "Running unit tests..."
        }
      }
    }
    stage('Static Analysis') {
      steps {
        script {
          echo "Running analysis..."
        }
      }
    }
    stage('Export Nexus') {
      steps {
        script {
          echo "Exporting to nexus..."
        }
      }
    }
    stage('Deployment') {
      when {
        equals expected: true, actual: requiresDeployment
      }
      steps {
        script {
          echo "Executing deployment..."
        }
      }//steps
    }//stage
    stage('Aprovar') {
      when {
        allOf {
          equals expected: true, actual: requiresDeployment
          equals expected: true, actual: requiresApproval
        }
      }
      input {
          message "Você gostaria de aprovar?"
          ok "Sim, gostaria."
          submitter "aprovadores"
          submitterParameter "USERNAME" 
      }
      steps {
        script {
          approved = true
        }
      }
    }
    stage('Build Image') {
      when {
        equals expected: true, actual: requiresDeployment
        equals expected: true, actual: approved
      }
      steps {
        script {
          echo "Building image..."
        }
      }//steps
    }//stage
    stage('Promover') {
      when {
        allOf {
          equals expected: true, actual: requiresDeployment
          equals expected: true, actual: requiresPromotion
          equals expected: false, actual: requiresDirectPromotion
        }
      }
      input {
          message "Você gostaria de promover?"
          ok "Sim, gostaria."
          submitter "deployers"
          submitterParameter "USERNAME" 
      }
      steps {
        script {
          promote = true
        }
      }//steps
    }//stage
    stage('Promoting Image') {
      when {
        equals expected: true, actual: requiresPromotion
        equals expected: true, actual: promote
      }
      steps {
        script {
          echo "Promoting image..."
        }
      }//steps
    }//stage
    stage('Finalizando') {
      steps {
        script {
          echo "Finalizing..."
        }
      }
    }
  }//stages
}//pipeline